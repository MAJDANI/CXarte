<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="mission">

	<typeAlias alias="mission" type="com.novedia.talentmap.model.entity.Mission"/>
 	<typeAlias alias="colleague" type="com.novedia.talentmap.model.entity.Colleague"/> 
 	<typeAlias alias="tool" type="com.novedia.talentmap.model.entity.Tool"/> 
 
 	<resultMap id="toolResult"                    class="tool">
    	<result property="id"                     column="TOOL_ID"/> 
        <result property="name"                   column="TOOL_NAME"/>      
        <result property="concept.id"             column="CONCEPT_ID"/>
<!--         <result property="concept.name"           column="CONCEPT_NAME"/>     -->

      
    </resultMap>
 
	<resultMap id="missionResult"         class="mission">
		<result property="id"             					column="MISSION_ID" />
		<result property="colleagueId"             			column="COLLEAGUE_ID" />
		<result property="title"           					column="TITLE" />
		<result property="place"     	  					column="PLACE" />
		<result property="notes"          					column="NOTES" jdbcType="String" />
		<result property="startDate"      					column="START_DATE" />
		<result property="endDate"       					column="END_DATE" />
		<result property="client.id" 						column="CLIENT_ID"/>
		<result property="client.name" 						column="CLIENT_NAME"/>
<!-- 		<result property="tools" 							resultMap="mission.toolResult"/> -->
<!-- 		<result property="tools.id" 							column="TOOL_ID"/> -->
<!-- 		<result property="tools.name" 						column="TOOL_NAME"/> -->
	</resultMap>
	
	 <select id="getMissionTools" resultMap="toolResult" parameterClass="Integer">
		SELECT * FROM TOOL tools, MISSION_TOOL mission_tool WHERE mission_tool.MISSION_ID = #value# 
		AND mission_tool.TOOL_ID = tools.TOOL_ID
	</select>	
	
	<!-- <select id="getAll" resultMap="missionResult" parameterClass="Integer"> -->
<!-- 		SELECT  -->
<!-- 		mission.MISSION_ID, -->
<!-- 		COLLEAGUE_ID, -->
<!-- 		TITLE, -->
<!-- 		PLACE, -->
<!-- 		NOTES, -->
<!-- 		START_DATE, -->
<!-- 		END_DATE, -->
<!-- 		mission.CLIENT_ID, -->
<!-- 		CLIENT_NAME, -->
<!-- 		missionTool.TOOL_ID, -->
<!-- 		TOOL_NAME, -->
<!-- 		CONCEPT_ID -->
		
<!-- 		FROM MISSION mission, CLIENT client,TOOL tool,MISSION_TOOL missionTool -->
<!-- 		WHERE COLLEAGUE_ID = #value#  -->
<!-- 		AND mission.CLIENT_ID = client.CLIENT_ID -->
<!-- 		AND mission.MISSION_ID=missionTool.MISSION_ID -->
<!-- 		AND missionTool.TOOL_ID=tool.TOOL_ID -->
<!-- 		ORDER BY START_DATE -->
<!-- 	</select> -->

	<select id="get" resultMap="missionResult" parameterClass="Integer">
		SELECT * FROM MISSION mission, CLIENT client
		WHERE mission.MISSION_ID = #id# AND mission.CLIENT_ID = client.CLIENT_ID
	</select>

	<select id="getAllByColleague" resultMap="missionResult" parameterClass="Integer">
		SELECT * FROM MISSION mission, CLIENT client WHERE COLLEAGUE_ID = #value# 
		AND mission.CLIENT_ID = client.CLIENT_ID
		ORDER BY START_DATE
	</select>
	
	<select id="getLastMissionByColleague" resultMap="missionResult" parameterClass="Integer">
		SELECT * FROM MISSION mission, CLIENT client WHERE COLLEAGUE_ID = #value# 
		AND mission.CLIENT_ID = client.CLIENT_ID
		AND mission.END_DATE = (SELECT MAX(END_DATE) FROM MISSION mission WHERE COLLEAGUE_ID = #value#)
	</select>
	
	
	<update id="save" parameterClass="Mission">
		UPDATE MISSION 
		SET
		MISSION_ID = #id#, COLLEAGUE_ID = #colleagueId#, TITLE = #title#, PLACE = #place#, 
		CLIENT_ID = #client.id#, NOTES = #notes#, START_DATE = #startDate#, END_DATE = #endDate# 
		WHERE MISSION_ID = #id#
	</update>

	<insert id="add" parameterClass="Mission">

		INSERT INTO MISSION 
		(COLLEAGUE_ID, TITLE, PLACE, CLIENT_ID, NOTES, START_DATE, END_DATE) 
		values 
		(#colleagueId#, #title#, #place#, #client.id#, #notes#, #startDate#, #endDate#)

		<selectKey keyProperty="id" resultClass="Integer">
			SELECT LAST_INSERT_ID() AS MISSION_ID
		</selectKey>
	</insert>

	<delete id="delete" parameterClass="Integer">
		DELETE MISSION WHERE MISSION_ID = #id#
	</delete>

</sqlMap>