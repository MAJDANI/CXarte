<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="colleague">

    <typeAlias alias="colleague" type="com.novedia.talentmap.model.entity.Colleague"/> 
    <typeAlias alias="manager" type="com.novedia.talentmap.model.entity.Manager"/> 

    <resultMap id="colleagueResult" class="colleague">
        <result property="id" column="COLLEAGUE_ID"/>     
        <result property="managerId"  column="MANAGER_ID"/>         
        <result property="profileId"  column="PROFILE_ID"/>    	    
        <result property="lastName"   column="LAST_NAME"/>	   
        <result property="firstName"  column="FIRST_NAME"/>	   
        <result property="email"      column="EMAIL"/>	    
        <result property="phone"      column="PHONE"/>
        <result property="employmentDate"  column="EMPLOYMENT_DATE"/>	    
        <result property="experience"   column="EXPERIENCE"/>
		<result property="businessEngineer" column="B_ENGINEER_ID" select="colleague.getBusinessEngineer" />
    </resultMap>

   <resultMap id="managerResult" class="com.novedia.talentmap.model.entity.Manager">
        <result property="id" column="COLLEAGUE_ID"/>     
        <result property="managerId"  column="MANAGER_ID"/>         
        <result property="profileId"  column="PROFILE_ID"/>    	    
        <result property="lastName"   column="LAST_NAME"/>	   
        <result property="firstName"  column="FIRST_NAME"/>	   
        <result property="email"      column="EMAIL"/>	    
        <result property="phone"      column="PHONE"/>
        <result property="employmentDate"  column="EMPLOYMENT_DATE"/>	    
        <result property="experience"   column="EXPERIENCE"/>
		<result property="businessEngineer" column="B_ENGINEER_ID" select="colleague.getBusinessEngineer" />
    </resultMap>

	<resultMap id="businessEngineerResult" class="com.novedia.talentmap.model.entity.BusinessEngineer">
		<result property="id" column="B_ENGINEER_ID"/>
		<result property="name" column="NAME"/>
	</resultMap>
	
	<select id="getBusinessEngineer" parameterClass="int" resultMap="businessEngineerResult">
		select * from BUSINESS_ENGINEER where B_ENGINEER_ID = #value#
	</select>

    <select id="get" parameterClass="Integer" resultMap="colleagueResult">
        SELECT * FROM  COLLEAGUE WHERE COLLEAGUE_ID = #id#
    </select>
    
    <select id="getAll" resultMap="colleagueResult">
    	SELECT * FROM COLLEAGUE
    </select>
    					 
	<update id="save" parameterClass="Colleague">
		UPDATE COLLEAGUE SET PROFILE_ID = #profileId#, PHONE = #phone#, EXPERIENCE = #experience# WHERE COLLEAGUE_ID = #id#
	</update>

    <select id="getManager" parameterClass="Integer" resultMap="managerResult">
        SELECT * FROM  COLLEAGUE WHERE COLLEAGUE_ID = #id#
    </select>
	
    <select id="getAllColleaguesByLastName" parameterClass="string" resultMap="colleagueResult">
        SELECT * FROM  COLLEAGUE WHERE UPPER(LAST_NAME) LIKE UPPER('$lastName$%')
    </select>

    <select id="getAllColleaguesByClient" parameterClass="com.novedia.talentmap.model.entity.Client" resultMap="colleagueResult">
        SELECT DISTINCT c.* FROM  MISSION m, COLLEAGUE c 
        WHERE m.COLLEAGUE_ID = c.COLLEAGUE_ID
        AND m.CLIENT_ID = #id#
    </select>

	<select id="getAllColleaguesByListToolId" resultMap="colleagueResult" parameterClass="java.util.Hashtable">
  		SELECT c.* FROM 
		(SELECT s.COLLEAGUE_ID, COUNT(*) as nbTool FROM SKILL s
		WHERE s.TOOL_ID IN 
		<iterate 	property = "listId"
					open="(" 
					close=")"
					conjunction=",">
   					#listId[]#
  		</iterate>
		GROUP BY s.COLLEAGUE_ID) a, COLLEAGUE c
		WHERE a.COLLEAGUE_ID = c.COLLEAGUE_ID
		AND a.nbTool = #listSize[0]#
    </select>	

	<insert id="add">
		<selectKey resultClass="Integer" keyProperty="id">
      		SELECT SEQCOLLEAGUE.NEXTVAL FROM DUAL
    	</selectKey>
 	
    	INSERT INTO COLLEAGUE (
    		MANAGER_ID,
    		PROFILE_ID,
    		LAST_NAME,
    		FIRST_NAME, 
    		EMAIL,
    		PHONE,
    		EMPLOYMENT_DATE,
    		EXPERIENCE,
    		B_ENGINEER_ID
    		)values (
			#managerId#, #profileId#, #lastName#, #firstName#, #email#, #phone#, #employmentDate#, #experience#, #businessEngineer.id#
    		)
	</insert>
	
    <select id="getAllCollaboratorsByManagerId" parameterClass="Integer" resultMap="colleagueResult">
        SELECT * FROM COLLEAGUE WHERE MANAGER_ID = #id#
    </select>
    
    <select id="getAllConsultantManager" resultMap="colleagueResult">
		SELECT DISTINCT C1.* 
		FROM COLLEAGUE C1, COLLEAGUE c2 
		WHERE C1.COLLEAGUE_ID = C2.MANAGER_ID
		ORDER BY C1.LAST_NAME
    </select>
    
    <select id="check" parameterClass="com.novedia.talentmap.model.entity.Registration" resultMap="colleagueResult">
        SELECT * FROM COLLEAGUE WHERE EMAIL = #email#
    </select>
    
    <insert id="addColleagueFromRegistration" parameterClass="com.novedia.talentmap.model.entity.Registration">
	    <selectKey resultClass="Integer" keyProperty="colleagueId">
      		SELECT SEQCOLLEAGUE.NEXTVAL FROM DUAL
    	</selectKey>
 	
    	INSERT INTO COLLEAGUE (
    		COLLEAGUE_ID,
    		MANAGER_ID,
    		PROFILE_ID,
    		LAST_NAME,
    		FIRST_NAME, 
    		EMAIL,
    		PHONE,
    		EMPLOYMENT_DATE,
    		EXPERIENCE,
    		B_ENGINEER_ID
    		)values (#colleagueId#,
			#managerId#, #profileId#, UPPER(#lastName#), #firstName#, #email#, #phone#, #employmentDate#, #experience#, #businessEngineer.id#
    		)
	</insert>
    
</sqlMap>