<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="mission">

	<typeAlias alias="mission" type="com.novedia.talentmap.model.entity.Mission"/>

	<resultMap id="missionResult"         class="mission">
		<result property="id"             column="MISSION_ID" />
		<result property="colleague"      column="COLLEAGUE_ID" select="mission.getColleague"/>
		<result property="title"           column="NAME" />
		<result property="place"     	  column="PLACE" />
		<result property="client"         column="CLIENT_ID" select="mission.getClient" />
		<result property="notes"          column="NOTES" jdbcType="String" />
		<result property="startDate"      column="START_DATE" />
		<result property="endDate"        column="END_DATE" />
	</resultMap>
	
	<resultMap id="clientResult" class="com.novedia.talentmap.model.entity.Client">
		<result property="id" column="CLIENT_ID"/>
		<result property="name" column="CLIENT_NAME"/>
	</resultMap>

    <resultMap id="colleagueResult" class="colleague">
        <result property="id" column="COLLAB_ID"/>     
        <result property="managerId"  column="MANAGER_ID"/>         
        <result property="profileId"  column="PROFILE_ID"/>    	    
        <result property="lastName"   column="LAST_NAME"/>	   
        <result property="firstName"  column="FIRST_NAME"/>	   
        <result property="email"      column="EMAIL"/>	    
        <result property="phone"      column="PHONE"/>
        <result property="employmentDate"  column="EMPLOYMENT_DATE"/>	    
        <result property="experience"   column="EXPERIENCE"/>
		<result property="businessEngineer" column="B_ENGINEER_ID" select="colleague.getBusinessEngineer" />
    </resultMap>
	
	<select id="getClient" parameterClass="int" resultMap="clientResult">
		select * from CLIENT where CLIENT_ID = #value#
	</select>

	<select id="getColleague" parameterClass="int" resultMap="colleagueResult">
		select * from COLLEAGUE where COLLEAGUE_ID = #value#
	</select>

	<select id="get" resultMap="missionResult" parameterClass="Integer">
		SELECT * FROM MISSION WHERE MISSION_ID = #id#
	</select>

	<select id="getAllByColleague" resultMap="missionResult" parameterClass="Integer">
		SELECT * FROM MISSION WHERE COLLEAGUE_ID = #value# 
		ORDER BY START_DATE
	</select>
	
	<update id="save" parameterClass="Mission">
		UPDATE MISSION 
		SET
		MISSION_ID = #id#, COLLEAGUE_ID = #colleague.id#, NAME = #title#, PLACE = #place#, 
		CLIENT_ID = #client.id#, NOTES = #notes#, START_DATE = #startDate#, END_DATE = #endDate# 
		WHERE MISSION_ID = #id#
	</update>

	<insert id="add" parameterClass="Mission">

		<selectKey resultClass="int" keyProperty="id">
			SELECT SEQMISSION.NEXTVAL FROM DUAL
		</selectKey>

		INSERT INTO MISSION 
		(MISSION_ID, COLLEAGUE_ID, NAME, PLACE, CLIENT_ID, NOTES, START_DATE, END_DATE) 
		values 
		(#id#, #colleague.id#, #title#, #place#, #client.id#, #notes#, #startDate#, #endDate#)

		<selectKey keyProperty="id" resultClass="Integer">
			SELECT LAST_INSERT_ID() AS id
		</selectKey>
	</insert>

	<delete id="delete" parameterClass="Integer">
		DELETE MISSION WHERE MISSION_ID = #id#
	</delete>

</sqlMap>