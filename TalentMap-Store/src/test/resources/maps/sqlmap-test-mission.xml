<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL MAP 2.0//EN" 
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="mission">

	<typeAlias alias="mission" type="com.novedia.talentmap.model.entity.Mission" />
	<typeAlias alias="colleague"
		type="com.novedia.talentmap.model.entity.Colleague" />
	<typeAlias alias="tool" type="com.novedia.talentmap.model.entity.Tool" />

	<resultMap id="toolResult" class="tool">
		<result property="id" column="TOOL_ID" />
		<result property="name" column="TOOL_NAME" />
		<result property="concept.id" column="CONCEPT_ID" />
	</resultMap>



	<resultMap id="missionResult" class="mission">
		<result property="id" column="MISSION_ID" />
		<result property="colleagueId" column="COLLEAGUE_ID" />
		<result property="title" column="TITLE" />
		<result property="place" column="PLACE" />
		<result property="notes" column="NOTES" jdbcType="String" />
		<result property="startDate" column="START_DATE" />
		<result property="endDate" column="END_DATE" />
		<result property="role" column="ROLE" />
		<result property="client.id" column="CLIENT_ID" />
		<result property="client.name" column="CLIENT_NAME" />
		<result property="tools" column="MISSION_ID" select="mission.getMissionTools" />
	</resultMap>


	<select id="getMissionTools" resultMap="toolResult"
		parameterClass="Integer">
		SELECT * FROM TOOL tools, MISSION_TOOL mission_tool
		WHERE mission_tool.MISSION_ID = #value#
		AND mission_tool.TOOL_ID =
		tools.TOOL_ID
	</select>

	<select id="get" resultMap="missionResult" parameterClass="Integer">
		SELECT * FROM MISSION mission, CLIENT client
		WHERE mission.MISSION_ID =
		#id# AND mission.CLIENT_ID = client.CLIENT_ID
	</select>

	<select id="getAllByColleague" resultMap="missionResult"
		parameterClass="Integer">
		SELECT * FROM MISSION mission, CLIENT client WHERE
		COLLEAGUE_ID = #value#
		AND mission.CLIENT_ID = client.CLIENT_ID
		ORDER BY
		START_DATE desc
	</select>

	<select id="getLastMissionByColleague" resultMap="missionResult"
		parameterClass="Integer">
		select * FROM MISSION mission
		join CLIENT client on
		(mission.CLIENT_ID = client.CLIENT_ID)
		WHERE COLLEAGUE_ID = #value#
		and
		mission.start_date = (select max(start_date) from MISSION WHERE
		COLLEAGUE_ID = #value#)
	</select>




	<update id="save" parameterClass="Mission">
		UPDATE MISSION
		SET
		MISSION_ID =
		#id#, COLLEAGUE_ID = #colleagueId#, TITLE = #title#,
		PLACE = #place#,
		CLIENT_ID = #client.id#, NOTES = #notes#, START_DATE = #startDate#,
		END_DATE =
		#endDate#
		WHERE MISSION_ID = #id#
	</update>

	<insert id="add" parameterClass="Mission">

		<selectKey resultClass="int" keyProperty="id">
			SELECT
			SEQMISSION.NEXTVAL FROM DUAL
		</selectKey>

		INSERT INTO MISSION
		(MISSION_ID, COLLEAGUE_ID, TITLE, PLACE, CLIENT_ID,
		NOTES, START_DATE, END_DATE)
		values
		(#id#, #colleagueId#, #title#,
		#place#, #client.id#, #notes#, #startDate#,
		#endDate#)

	</insert>

	<delete id="delete" parameterClass="Integer">
		DELETE FROM MISSION WHERE
		MISSION_ID = #id#
	</delete>

</sqlMap>